name: Frontend Build & Tests

on:
  push:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-tests.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'frontend/**'
  workflow_dispatch:

jobs:
  lint-and-build:
    name: Lint and Build Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      working-directory: frontend
      run: npm ci
    
    - name: Check for linting errors
      working-directory: frontend
      run: |
        if npm run lint 2>/dev/null; then
          echo "✓ Linting passed"
        else
          echo "⚠️  No lint script or linting failed (non-blocking)"
        fi
      continue-on-error: true
    
    - name: Build frontend
      working-directory: frontend
      run: npm run build
      env:
        VITE_API_URL: https://api.example.com
    
    - name: Check build output
      working-directory: frontend
      run: |
        ls -lah dist/
        test -f dist/index.html
        echo "✓ Build successful, index.html exists"
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist/
        retention-days: 7

  check-bundle-size:
    name: Check Bundle Size
    runs-on: ubuntu-latest
    needs: lint-and-build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: frontend-build
        path: frontend/dist/
    
    - name: Check bundle size
      working-directory: frontend
      run: |
        TOTAL_SIZE=$(du -sb dist/ | cut -f1)
        TOTAL_MB=$(echo "scale=2; $TOTAL_SIZE / 1048576" | bc)
        echo "Total bundle size: ${TOTAL_MB}MB"
        
        # Warn if bundle is too large (>10MB)
        if [ $(echo "$TOTAL_MB > 10" | bc) -eq 1 ]; then
          echo "⚠️  Warning: Bundle size is large (${TOTAL_MB}MB)"
        else
          echo "✓ Bundle size OK (${TOTAL_MB}MB)"
        fi

  test-env-config:
    name: Test Environment Configuration
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Check environment config
      working-directory: frontend
      run: |
        # Verify VITE_API_URL is used (localhost fallback is OK for dev)
        if grep -r "VITE_API_URL" src/services/api.js; then
          echo "✓ VITE_API_URL is used in api.js"
        else
          echo "⚠️  VITE_API_URL not found in api.js"
          exit 1
        fi
        
        # Check that localhost is only used as fallback, not hardcoded
        if grep -r "http://localhost:8000" src/ --exclude-dir=node_modules | grep -v "VITE_API_URL.*localhost"; then
          echo "⚠️  Found hardcoded localhost:8000 (should only be fallback)"
          exit 1
        fi
        
        echo "✓ Environment configuration is correct"

  test-component-imports:
    name: Validate Component Imports
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      working-directory: frontend
      run: npm ci
    
    - name: Check for import errors
      working-directory: frontend
      run: |
        # Try to import main entry point
        node -e "console.log('Checking imports...')"
        
        # Verify all pages exist
        test -f src/pages/Home.jsx
        test -f src/pages/Submit.jsx
        test -f src/pages/DatasetLeaderboard.jsx
        test -f src/pages/CreateDataset.jsx
        test -f src/pages/SubmissionHistory.jsx
        test -f src/pages/Docs.jsx
        test -f src/pages/DomainBenchmarks.jsx
        
        # Verify all key components exist
        test -f src/components/LeaderboardCard.jsx
        test -f src/components/SubmissionForm.jsx
        test -f src/components/DatasetForm.jsx
        test -f src/components/MultiMetricLeaderboard.jsx
        test -f src/components/DetailedMetrics.jsx
        
        echo "✓ All pages and components exist"

  summary:
    name: Frontend Tests Summary
    runs-on: ubuntu-latest
    needs:
      - lint-and-build
      - check-bundle-size
      - test-env-config
      - test-component-imports
    if: always()
    
    steps:
    - name: Check results
      run: |
        echo "Frontend test results:"
        echo "  Build: ${{ needs.lint-and-build.result }}"
        echo "  Bundle size: ${{ needs.check-bundle-size.result }}"
        echo "  Env config: ${{ needs.test-env-config.result }}"
        echo "  Component imports: ${{ needs.test-component-imports.result }}"
        
        if [ "${{ needs.lint-and-build.result }}" != "success" ]; then
          echo "❌ Frontend build failed"
          exit 1
        fi
        
        echo "✓ Frontend tests passed"

